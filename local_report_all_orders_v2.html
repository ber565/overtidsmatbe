
<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lokal rapport – oppdatert</title>
<style>
 body{font-family:Arial,sans-serif;background:#f5f7fb;margin:0}
 header{background:#004578;color:#fff;padding:20px;text-align:center}
 main{max-width:1160px;margin:20px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
 table{width:100%;border-collapse:collapse;margin-top:20px}
 th,td{border:1px solid #ccc;padding:8px;text-align:left}
 th{background:#eee}
 tfoot td{font-weight:bold;background:#f7f7f7}
 .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<header><h1>Lokal rapport – alle bestillinger</h1></header>
<main>
  <div class="row">
    <label>Leverandør:</label><select id="fs"><option value="">Alle</option></select>
    <label>Fra:</label><input type="date" id="fd"><label>Til:</label><input type="date" id="td">
    <button id="csv">CSV</button><button id="cl">Nullstill</button>
  </div>
  <table>
    <thead><tr><th>Innsendt</th><th>Lev</th><th>Bestiller</th><th>Avd</th><th>Meny</th><th>Valg</th><th>Tillegg</th><th>Drikke</th><th>Variant</th><th>Drikketillegg</th><th>Merknad</th><th>Sted</th><th>Dato</th><th>Tid</th><th>Mat</th><th>Brus</th><th>Total</th><th></th></tr></thead>
    <tbody id="T"></tbody>
    <tfoot><tr><td colspan="14">Sum filtrert:</td><td id="SF">0</td><td id="SD">0</td><td id="ST">0</td><td></td></tr></tfoot>
  </table>
</main>
<script src="overtidsmat_shared.js"></script>
<script>
function g(i){return document.getElementById(i);} 
function loadSup(){const cfg=OvertidsmatConfig.loadConfig(); OvertidsmatConfig.getSuppliers(cfg).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;g('fs').appendChild(o);});}
function getOrders(){return JSON.parse(localStorage.getItem('orders')||'[]');}
function passDateRange(o){const f=g('fd').value, t=g('td').value; if(f && o.date < f) return false; if(t && o.date > t) return false; return true;}
function filt(){const s=g('fs').value; return getOrders().filter(o=>!s||o.supplier===s).filter(passDateRange);} 
function delRec(ts){let o=getOrders(); const before=o.length; o=o.filter(x=>x.timestamp!==ts); localStorage.setItem('orders',JSON.stringify(o)); return before!==o.length;}
function rend(){const rows=filt(); const T=g('T'); T.innerHTML=''; let SF=0,SD=0,ST=0;
rows.forEach(o=>{const f=Number(o.totalFood||0), d=Number(o.totalDrink||0), tt=(o.total!=null?Number(o.total):f+d); SF+=f;SD+=d;ST+=tt;
const tr=document.createElement('tr'); tr.innerHTML='<td>'+new Date(o.timestamp).toLocaleString()+'</td><td>'+o.supplier+'</td><td>'+o.name+'</td><td>'+o.department+'</td><td>'+o.menu+'</td><td>'+(o.submenu||'')+'</td><td>'+((o.extras||[]).join(', '))+'</td><td>'+(o.drink||'')+'</td><td>'+(o.drinkVariant||'')+'</td><td>'+((o.drinkExtras||[]).join(', '))+'</td><td>'+(o.remarks||'')+'</td><td>'+(o.deliveryPlace||'')+'</td><td>'+o.date+'</td><td>'+o.time+'</td><td>'+f+'</td><td>'+d+'</td><td>'+tt+'</td><td><button class="dangerBtn">Slett</button></td>';
const btn=tr.querySelector('.dangerBtn'); btn.onclick=()=>{ if(confirm('Slette?')){ if(delRec(o.timestamp)){ rend(); } } };
T.appendChild(tr);}); g('SF').textContent=SF; g('SD').textContent=SD; g('ST').textContent=ST;} 
function esc(v){return '"'+String(v).replaceAll('"','""')+'"';}
function toCSV(){const rows=filt(); let out=['Innsendt,Lev,Bestiller,Avd,Meny,Valg,Tillegg,Drikke,Variant,Drikketillegg,Merknad,Sted,Dato,Tid,Mat,Brus,Total']; let SF=0,SD=0,ST=0;
rows.forEach(o=>{const f=Number(o.totalFood||0), d=Number(o.totalDrink||0), tt=(o.total!=null?Number(o.total):f+d); SF+=f;SD+=d;ST+=tt;
out.push([new Date(o.timestamp).toLocaleString(),o.supplier,o.name,o.department,o.menu,o.submenu||'',(o.extras||[]).join('; '),o.drink||'',o.drinkVariant||'',(o.drinkExtras||[]).join('; '),o.remarks||'',o.deliveryPlace||'',o.date,o.time,f,d,tt].map(esc).join(','));});
out.push(['SUM','','','','','','','','','','','','',SF,SD,ST].map(esc).join(',')); return out.join('
');}

g('csv').onclick=()=>{const csv=toCSV(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='lokal_rapport.csv'; a.click();};
g('cl').onclick=()=>{g('fs').value=''; g('fd').value=''; g('td').value=''; rend();}; g('fs').onchange=rend; g('fd').onchange=rend; g('td').onchange=rend;
loadSup(); rend();
</script>
</body>
</html>
