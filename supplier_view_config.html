<!DOCTYPE html><html lang="no"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Leverandørvisning</title><style>body{font-family:Arial,sans-serif;background:#f5f7fb;margin:0;padding:0}header{background:#004578;color:#fff;padding:20px;text-align:center}main{max-width:1160px;margin:20px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ccc;padding:8px;text-align:left}th{background:#eee}select,input,button{padding:8px;margin-top:10px}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.muted{opacity:.8;font-size:.92rem}.notice{color:#a80000;font-weight:bold;margin-top:10px}.danger{background:#a80000;color:#fff;border:0;border-radius:6px;padding:6px 10px;cursor:pointer}</style></head><body><header><h1>Leverandørvisning</h1><div class="muted">Passordbeskyttelse er klientside (enkel sperre). Sletting påvirker kun data i denne løsningen.</div></header><main><div id="notice" class="notice" style="display:none">Ingen leverandører er registrert. Legg til leverandører i admin-siden.</div><div class="row"><label>Leverandør:</label><select id="filterSupplier"></select><label>Dato:</label><input id="dateFilter" type="date"><button id="csvBtn" type="button" style="display:none">Last ned CSV</button></div><div class="row" id="pwRow" style="display:none"><input id="pwInput" type="password" placeholder="Passord for valgt leverandør"><button id="pwCheckBtn" type="button">Lås opp</button></div><table><thead><tr><th>Innsendt</th><th>Bestiller</th><th>Avdeling</th><th>Meny</th><th>Menyvalg</th><th>Tillegg (mat)</th><th>Drikke</th><th>Drikkevariant</th><th>Drikketillegg</th><th>Merknad</th><th>Leveringssted</th><th>Leveringsdato</th><th>Leveringstid</th><th>Handling</th></tr></thead><tbody id="ordersTable"></tbody></table></main><script src="overtidsmat_shared.js"></script><script>const filterSelect=document.getElementById('filterSupplier');const ordersTable=document.getElementById('ordersTable');const dateFilter=document.getElementById('dateFilter');const pwRow=document.getElementById('pwRow');const pwInput=document.getElementById('pwInput');const pwCheckBtn=document.getElementById('pwCheckBtn');const csvBtn=document.getElementById('csvBtn');const notice=document.getElementById('notice');let unlockedSuppliers=new Set(JSON.parse(localStorage.getItem('overtidsmat_unlocked')||'[]'));function persistUnlocks(){localStorage.setItem('overtidsmat_unlocked',JSON.stringify(Array.from(unlockedSuppliers)));}function getQueryParam(n){const u=new URL(window.location.href);return u.searchParams.get(n)||'';}function populateSuppliers(){const cfg=OvertidsmatConfig.loadConfig();filterSelect.innerHTML='';const suppliers=OvertidsmatConfig.getSuppliers(cfg);if(!suppliers.length){notice.style.display='block';filterSelect.style.display='none';csvBtn.style.display='none';pwRow.style.display='none';return;}notice.style.display='none';filterSelect.style.display='';suppliers.forEach(name=>{const opt=document.createElement('option');opt.value=name;opt.textContent=name+(isUnlocked(name)?' (låst opp)':'');filterSelect.appendChild(opt);});}function isUnlocked(name){const cfg=OvertidsmatConfig.loadConfig();const s=OvertidsmatConfig.findSupplier(cfg,name);if(!s)return false; if(!s.password)return true;return unlockedSuppliers.has(name.toLowerCase());}function ensureAccessOrPrompt(){const selected=filterSelect.value;if(!selected)return false;const cfg=OvertidsmatConfig.loadConfig();const s=OvertidsmatConfig.findSupplier(cfg,selected);if(!s)return false;if(!s.password){pwRow.style.display='none';csvBtn.style.display='block';return true;}if(isUnlocked(selected)){pwRow.style.display='none';csvBtn.style.display='block';return true;}pwRow.style.display='';csvBtn.style.display='none';pwInput.value='';pwInput.focus();return false;}pwCheckBtn.onclick=()=>{const selected=filterSelect.value;const cfg=OvertidsmatConfig.loadConfig();const s=OvertidsmatConfig.findSupplier(cfg,selected);if(!s)return;if(pwInput.value===s.password){unlockedSuppliers.add(selected.toLowerCase());persistUnlocks();pwRow.style.display='none';csvBtn.style.display='block';populateSuppliers();renderOrders();}else{alert('Feil passord.');pwInput.select();}};function getOrders(){return JSON.parse(localStorage.getItem('orders')||'[]');}function saveOrders(arr){localStorage.setItem('orders',JSON.stringify(arr));}function getFilteredOrders(){const supplierFilter=filterSelect.value;const df=dateFilter.value;return getOrders().filter(o=>o.supplier===supplierFilter).filter(o=>!df||o.date===df);}function deleteOrderByTimestamp(ts){if(!ensureAccessOrPrompt())return;let orders=getOrders();const before=orders.length;orders=orders.filter(o=>o.timestamp!==ts);saveOrders(orders);return before!==orders.length;}function renderOrders(){if(!ensureAccessOrPrompt()){ordersTable.innerHTML='';return;}ordersTable.innerHTML='';const rows=getFilteredOrders();rows.forEach(o=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date(o.timestamp).toLocaleString()}</td><td>${o.name}</td><td>${o.department}</td><td>${o.menu}</td><td>${o.submenu||''}</td><td>${(o.extras||[]).join(', ')}</td><td>${o.drink||''}</td><td>${o.drinkVariant||''}</td><td>${(o.drinkExtras||[]).join(', ')}</td><td>${o.remarks||''}</td><td>${o.deliveryPlace||''}</td><td>${o.date}</td><td>${o.time}</td><td></td>`;const tdAction=tr.lastElementChild;const btn=document.createElement('button');btn.className='danger';btn.textContent='Slett';btn.onclick=()=>{if(!confirm('Slette denne bestillingen? Dette kan ikke angres.'))return;const ok=deleteOrderByTimestamp(o.timestamp);if(ok){tr.remove();}else{alert('Fant ikke bestillingen. Oppdater siden og prøv igjen.');}};tdAction.appendChild(btn);ordersTable.appendChild(tr);});}function toCSV(rows){const header=['Innsendt','Leverandør','Bestiller','Avdeling','Meny','Menyvalg','Tillegg (mat)','Drikke','Drikkevariant','Drikketillegg','Merknad','Leveringssted','Leveringsdato','Leveringstid'];const esc=v=>'"'+String(v).replaceAll('"','""')+'"';const lines=[header.map(esc).join(',')];rows.forEach(o=>{lines.push([new Date(o.timestamp).toLocaleString(),o.supplier,o.name,o.department,o.menu,(o.submenu||''),(o.extras||[]).join('; '),(o.drink||''),(o.drinkVariant||''),(o.drinkExtras||[]).join('; '),(o.remarks||''),(o.deliveryPlace||''),o.date,o.time].map(esc).join(','));});return lines.join('\n');}csvBtn.onclick=()=>{if(!ensureAccessOrPrompt())return;const rows=getFilteredOrders();const csv=toCSV(rows);const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');const dt=new Date();const namePart=filterSelect.value.replace(/\s+/g,'_');a.href=URL.createObjectURL(blob);a.download=`bestillinger_${namePart}_${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);};filterSelect.addEventListener('change',()=>{ensureAccessOrPrompt();renderOrders();});dateFilter.addEventListener('change',renderOrders);populateSuppliers();const pre=getQueryParam('supplier');if(pre){filterSelect.value=pre;filterSelect.disabled=true;}ensureAccessOrPrompt();renderOrders();</script></body></html>